<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.1"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<style type="text/css">
		
		#acc {
			font-weight: bold;
		}
		#acc.yes {
			color: green;
		}
		#acc.no {
			color: red;
		}
		
	</style>
</head>
  	<div class="container">
	<h3 style="text-align: center;"> Seismocardiograph with smartphone accelerometer</h3>
	</div>
   <body style="background-color:#FAFAFA; ">
	<div class="container">
	<div class="chart-container">
		<!-- Canvas untuk rendering chart -->
		<canvas id="chartCanvas" width="80" height="40"></canvas>
	</div>
	</div>
	<script> 
		var zbandpass;
		var EMAalow=0.01;
		var EMAslow=0;
		var EMAahigh=0.95;
		var EMAshigh=0;
		<!-- Mengambil referensi canvas chart -->
		const self = this; // refer this within script tag context
		let interval = null;

		const maxThreshold = 50;
		const seconds = [0]; // x
		const datas = [0]; // y
		const datasclean = [0]; // y
		var beatarray=[];
		var averagearray=[];
		//bpm,sys,dias data
		var outlier=[];
		var systolearray=[];
		var timesystolearray=[];
		var diastolearray=[];
		var bpm=0;
		var systole=0;
		var diastole=0;
		var i=0;
		var j=0;
		var k=0;
		var yy=0;
		var ya=0;
		var yb=0;
		var ibisystole=[];
		var arraybpm=[];
		var sys;

		init();
		<!-- Mengambil referensi canvas chart -->
		const ctxChart = document.getElementById('chartCanvas').getContext('2d');
		<!-- Membuat data pada chart dengan type serta labels yang sesuai -->
		const chartInstance = new Chart(ctxChart, {
			type: 'line',
			data: {
				labels: seconds,
				datasets: [
					{
						spanGaps: true,
						pointRadius: 0 ,
						label: "y axis",
						fill: false,
						borderColor: 'rgb(57, 192, 43)',
						data: datas
					},
					{
						spanGaps: true,
						pointRadius: 0 ,
						label: "beep",
						fill: false,
						borderColor: 'rgb(200, 50, 43)',
						data: beatarray
					},
					{
						spanGaps: true,
						pointRadius: 0 ,
						label: "average signal",
						fill: false,
						borderColor: 'rgb(70, 50, 180)',
						data: averagearray
					},
				]
			},
			options: {
				spanGaps: true,
				animation:false,
				 
				hover: {
					animationDuration: 0 // duration of animations when hovering an item
				},
				line: {
					tension: 0, // disables bezier curves
					pointRadius: 0
				},
				responsiveAnimationDuration: 0 // animation duration after a resize
				
			}
		});
		
		if (window.DeviceMotionEvent == undefined) {
			//No accelerometer is present. Use buttons. 
			console.log('no');
		}
		else {
			console.log('yes');
			window.addEventListener("devicemotion", accelerometerUpdate, true);
		}
		function accelerometerUpdate(event) {
			
			var ax = event.acceleration.x;
			var ay = event.acceleration.y;
			sys=ay;
			var az = event.acceleration.z;
			let myavgbpm=document.getElementById("avgbpm");
			let myminbpm=document.getElementById("minbpm");
			let mymaxbpm=document.getElementById("maxbpm");
			
			let myavgibi=document.getElementById("avgibi");
			let myminibi=document.getElementById("minibi");
			let mymaxibi=document.getElementById("maxibi");
			
			let myavgsys=document.getElementById("avgsys");
			let myminsys=document.getElementById("minsys");
			let mymaxsys=document.getElementById("maxsys");
			
			let myavgdias=document.getElementById("avgdias");
			let mymindias=document.getElementById("mindias");
			let mymaxdias=document.getElementById("maxdias");
			
			let mynbpm=document.getElementById("nbpm");
			let mynibi=document.getElementById("nibi");
			let mynsys=document.getElementById("nsys");
			let myndia=document.getElementById("ndia");
			let myndata=document.getElementById("ndata");
			
			let mystatus=document.getElementById("svgheart");
			
			beatarray=smoothed_z_score(datas);
			if((beatarray[beatarray.length-1])==1){
				i++;
				timesystolearray[i]=new Date().getTime();
				var tempyy=yy;
				//var tempya=(Math.log(averagearray[averagearray.length-1]))/(Math.log(5));;
				var tempinterval=(timesystolearray[i])-(timesystolearray[i-1])
				var cleanarray = averagearray.filter(function (el) {
					  return el != ''&& el != 'NaN';
					});	
				if (tempinterval>400&&tempinterval<1500){
					ibisystole[j]=tempinterval;
					systolearray[j] = tempyy;
					var avgdiastole=Math.max(...cleanarray).toFixed(6)
					diastolearray[j]=(Math.log(avgdiastole))/(Math.log(5));
					j++;
					
				}
				myndata.innerHTML="Dataset:"+j;
				if(j>=20){
					systolearray[0]=systolearray[1];
					myavgbpm.innerHTML=(60000/(ibisystole.reduce((a,b) => a + b, 0) / ibisystole.length)).toFixed(2);
					myminbpm.innerHTML=(60000/Math.min(...ibisystole)).toFixed(2);
					mymaxbpm.innerHTML=(60000/Math.max(...ibisystole)).toFixed(2);
					
					myavgibi.innerHTML=(ibisystole.reduce((a,b) => a + b, 0) / ibisystole.length).toFixed(2);
					myminibi.innerHTML=(Math.min(...ibisystole)).toFixed(2);
					mymaxibi.innerHTML=(Math.max(...ibisystole)).toFixed(2);
					
					var systolearrayclean = systolearray.filter(function (el) {
					  return el !=NaN;
					});
					myavgsys.innerHTML=(systolearrayclean.reduce((a,b) => a + b, 0) / systolearrayclean.length).toFixed(6);
					myminsys.innerHTML=Math.max(...systolearrayclean).toFixed(6);
					mymaxsys.innerHTML=Math.min(...systolearrayclean).toFixed(6);
					var diastolearrayclean = diastolearray.filter(function (el) {
					  return el !=NaN;
					});
					myavgdias.innerHTML=(diastolearrayclean.reduce((a,b) => a + b, 0) / diastolearrayclean.length).toFixed(4);
					mymindias.innerHTML=Math.max(...diastolearrayclean).toFixed(6);
					mymaxdias.innerHTML=Math.min(...diastolearrayclean).toFixed(6);
					i=0;
					j=0;
					//ibisystole=[];
					//systolearray=[];
					//diastolearray=[];
				}			
			}
			var linamplifier=(((ay-0)*(10-0))/(1-0))+0;
			var linearamplified=ay*linamplifier;
			var logamplified=Math.pow(5,linearamplified);
			EMAslow=(EMAalow*logamplified)+((1-EMAalow)*EMAslow);
		    EMAshigh=(EMAahigh*logamplified)+((1-EMAahigh)*EMAshigh);
			bandpass=(EMAshigh-EMAslow);
			if(bandpass>100&&bandpass<-100){
				mystatus.style.fill='grey'
			}else{
				mystatus.style.fill='red'	 
			}
				let len = seconds.length;
				if (len > maxThreshold) {
					seconds.shift();
					datas.shift();
					len = seconds.length;
				}
				seconds.push(addTime());
				datas.push(bandpass);
				refresh();
				
				function startInterval () {
					interval = setInterval(addData,10);
				}

				function stopInterval () {
					clearInterval(interval);
				}

				function refresh () {
					chartInstance.labels = seconds;
					chartInstance.data.datasets[0].data = datas;
					chartInstance.data.datasets[1].data = beatarray;
					chartInstance.data.datasets[2].data = averagearray;
					chartInstance.update();
				}
		}
		
		function init () {
			for (let i = 0; i < maxThreshold; i++) {
				seconds.push(0);
				datas.push(0);
			}
		}

		function addTime () {
			const epoch = Math.floor(new Date().getTime()/1000.0);
			const myDate = new Date(epoch * 1000);
			const time = Date.now() + "";
			const ms = time.slice(time.length - 3);
			const dateFormat = `${myDate.getHours()}:${myDate.getMinutes()}:${myDate.getSeconds()}:${ms}`;
			return dateFormat;
		}
		
		function sum(a) {
			return a.reduce((acc, val) => acc + val)
		}

		function mean(a) {
			return sum(a) / a.length
		}

		function stddev(arr) {
			const arr_mean = mean(arr)
			const r = function(acc, val) {
				return acc + ((val - arr_mean) * (val - arr_mean))
			}
			return Math.sqrt(arr.reduce(r, 0.0) / arr.length)
		}

		function smoothed_z_score(y, params) {
			var p = params || {}
			// init cooefficients
			const lag = p.lag || 5
			const threshold = p.threshold || 5
			const influence = p.influece || 0.75

			if (y === undefined || y.length < lag + 2) {
				throw ` ## y data array to short(${y.length}) for given lag of ${lag}`
			}
			//console.log(`lag, threshold, influence: ${lag}, ${threshold}, ${influence}`)

			// init variables
			var signals = Array(y.length).fill(0)
			var filteredY = y.slice(0)
			const lead_in = y.slice(0, lag)
			//console.log("1: " + lead_in.toString())

			var avgFilter = []
			avgFilter[lag - 1] = mean(lead_in)
			averagearray=avgFilter;
			var stdFilter = []
			stdFilter[lag - 1] = stddev(lead_in)
			//console.log("2: " + stdFilter.toString())

			for (var i = lag; i < y.length; i++) {
				//console.log(`${y[i]}, ${avgFilter[i-1]}, ${threshold}, ${stdFilter[i-1]}`)
				if (Math.abs(y[i] - avgFilter[i - 1]) > (threshold * stdFilter[i - 1])) {
					if (y[i] > avgFilter[i - 1]) {
						signals[i] = +1 // positive signal
						yy=(Math.log(y[i]))/(Math.log(5));
						//ya=(Math.log(averagearray[]))/(Math.log(5));
					} else {
						signals[i] = -1 // negative signal
					}
					// make influence lower
					filteredY[i] = influence * y[i] + (1 - influence) * filteredY[i - 1]
				} else {
					signals[i] = 0 // no signal
					filteredY[i] = y[i];
				}

				// adjust the filters
				const y_lag = filteredY.slice(i - lag, i)
				avgFilter[i] = mean(y_lag)
				stdFilter[i] = stddev(y_lag)
			}

			return signals
		}
		
	
	</script>
	<!-- bismillah -->
	<div class="container">
	  
	  <h4 style="text-align: center;" >Heart beat (Y axis): <span id="accstat"> <svg id="svgheart" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="grey" class="bi bi-heart-fill" viewBox="0 0 16 16">
		 <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
		</svg></h4>
		
	  <br>
	  <table class="table table-bordered">
		<thead>
		  <tr> 
			<th id="ndata">Dataset</th>
			<th>Average</th>
			<th>Maximum</th>
			<th>Minimum</th>
		  </tr>
		</thead>
		<tbody>
		  <tr>
			<th id="nbpm">Heart Rate</th>
			<td id="avgbpm">bpm</p></td>
			<td id="minbpm">minbpm</td>
			<td id="maxbpm">maxbpm</td>
		  </tr>
		  <tr>
			<th id="nibi">Beat Interval</th>
			<td id="avgibi">ibi</td>
			<td id="minibi">minibi</td>
			<td id="maxibi">maxibi</td>
		  </tr>
		  <tr>
			<th id="nsys">Systole</th>
			<td id="avgsys" >sys</td>
			<td id="minsys">minsys</td>
			<td id="maxsys">maxsys</td>
		  </tr>
		  <tr>
			<th id="ndia">Diastole</th>
			<td id="avgdias">dias</td>
			<td id="mindias">mindias</td>
			<td id="maxdias">maxdias</td>
		  </tr>
		</tbody>
	  </table>
	</div>


  </body>
</html>
